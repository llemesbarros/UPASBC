<!--Version 2.0.2-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAJ6TrAFy+8QCC0vgA7+/vAC6n7ACE0/gAS2RuAKbU5QDAwMAAv+3+ACek6gApoeYAAAAAAAAAAAAAAAAARERERERERABEREREREREAEREREREREQAREREeIRERABJmZSohUREAERERKolVEQAREREozUVRABJmZRDNlFUAEREREQzZRUAREREREM2W1BJmZmZRDNlxUREREREQzZVREREREREMzVJmZmZmURDM0REREREREQzRERERERERAMAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAA" rel="icon" type="image/x-icon"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Ms+Madi&family=Roboto:wght@400;700&display=swap');
body{font-family:sans-serif}header img{margin-right:10px}th{padding-top:10px}.paciente td{width:100%;border-bottom:1px}td input[type=text]{width:100%;height:28px;text-transform:uppercase;border-width:0 0 1px 0;font:inherit}#data{height:28px;border-width:0 0 1px 0;text-align:center;font:inherit}#texto{height:640px}#page1{page-break-after:always}.ql-editor{font-size:16px;line-height:1.5}.ql-editor br{display:inline}.ql-editor ol{padding-left:28px;margin:0}.ql-editor li{margin:0 0 12px 0;padding-bottom:6px;border-bottom:1px dashed #bbb}.ql-editor li:last-child{margin-bottom:0;border-bottom:0}.ql-editor li::marker{font-weight:bold}
.custom-btn{border:1px solid #ccc!important;background:#fff!important;width:auto!important;height:24px!important;padding:0 5px!important;margin-right:5px!important;cursor:pointer;font-size:12px!important;border-radius:3px}.custom-btn:hover{background:#f0f0f0!important}.custom-select{height:24px;border:1px solid #ccc;border-radius:3px;font-size:12px;max-width:200px;vertical-align:top}.custom-label{font-size:12px;vertical-align:top;display:inline-block;margin-top:4px}
@media screen{.printonly,#pagenum{display:none}}
@media print{@page{size:A4 portrait;margin:10mm}body,html{margin:0;padding:0}.noprint,.ql-toolbar{display:none!important}#pagenum{display:block!important;position:relative;font-size:14px;text-align:right;margin:0 0 4mm 0;padding:0}#page1{break-after:page;page-break-after:always}#texto{border:0!important;height:160mm;overflow:hidden}.ql-editor{font-size:17px;line-height:1.45}h5{break-inside:avoid;page-break-inside:avoid}body.duasvias #page1 #pagenum span::after{content:"1ª VIA FARMÁCIA"}body.duasvias #page2 #pagenum span::after{content:"2ª VIA PACIENTE"}body:not(.duasvias) #page1 #pagenum span::after{content:"VIA ÚNICA"}}
.ql-font-sans-serif{font-family:sans-serif}.ql-font-serif{font-family:serif}.ql-font-monospace{font-family:monospace}.ql-font-roboto{font-family:"Roboto",sans-serif}.ql-font-msmadi{font-family:"Ms Madi",cursive}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value=sans-serif]::before,.ql-snow .ql-picker.ql-font .ql-picker-item[data-value=sans-serif]::before{content:"Sans"}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value=serif]::before,.ql-snow .ql-picker.ql-font .ql-picker-item[data-value=serif]::before{content:"Serif"}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value=monospace]::before,.ql-snow .ql-picker.ql-font .ql-picker-item[data-value=monospace]::before{content:"Mono"}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value=roboto]::before,.ql-snow .ql-picker.ql-font .ql-picker-item[data-value=roboto]::before{content:"Roboto"}
.ql-snow .ql-picker.ql-font .ql-picker-label[data-value=msmadi]::before,.ql-snow .ql-picker.ql-font .ql-picker-item[data-value=msmadi]::before{content:"Ms Madi"}
</style>
<script src="medicamentos.json"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script>
let quill = null;

function addMedicamento(el) {
    if (!quill) return;
    const opt = el.selectedOptions && el.selectedOptions[0];
    if (!opt || opt.value === "0") return;
    const nome = opt.dataset.desc || "";
    const pos = opt.dataset.pos || "";
    if (!nome) return;

    const idx = Math.max(0, quill.getLength() - 1);
    
    // 1. Insere Título (Negrito)
    quill.insertText(idx, nome, { bold: true }, "user");
    
    let nextIdx = idx + nome.length;
    
    // 2. Insere Posologia (Normal) com quebras soft
    if (pos) {
        quill.insertEmbed(nextIdx, "softbreak", true, "user");
        nextIdx++;
        
        // Divide o texto pelas quebras de linha reais
        const lines = pos.split("\n");
        
        lines.forEach(function(line, i) {
            quill.insertText(nextIdx, line, { bold: false }, "user");
            nextIdx += line.length;
            
            // Se não for a última linha, insere <br>
            if (i < lines.length - 1) {
                quill.insertEmbed(nextIdx, "softbreak", true, "user");
                nextIdx++;
            }
        });
    }

    // 3. Fecha o item com \n
    quill.insertText(nextIdx, "\n", {}, "user");
    
    // 4. Aplica lista ordenada na linha inteira
    quill.formatLine(idx, 1, "list", "ordered", "user");
    
    // 5. Reset
    quill.setSelection(quill.getLength(), 0, "silent");
    el.value = "0";
    el.focus();
}

function limparTudo() {
    if(quill) quill.setContents([]);
}

window.addEventListener("DOMContentLoaded", function() {
    // === 1. Carrega Lista ===
    let lista = [];
    try {
        if (window.localStorage.medicamentos != undefined) {
            lista = JSON.parse(localStorage.medicamentos);
        } else if (typeof window.medicamentos !== 'undefined' && Array.isArray(window.medicamentos)) {
            lista = window.medicamentos;
        }
    } catch(e) {
        lista = (typeof window.medicamentos !== 'undefined' && Array.isArray(window.medicamentos)) ? window.medicamentos : [];
    }

    // Adiciona Sutura
    lista.push({
        nome: "ORIENTAÇÕES DE SUTURA",
        descricao: "ORIENTAÇÕES DE CUIDADOS COM A SUTURA",
        posologia: "- Mantenha a área da sutura limpa e seca, limpando suavemente com água e sabão neutro;\n- Em caso de troca do curativo, use sempre gaze estéril e evite tocar a parte interna;\n- Retorne em caso de sinais como vermelhidão, inchaço, calor, dor intensa ou secreção purulenta;\n- Evite atividades físicas intensas, mantenha uma dieta equilibrada e hidrate-se bem;\n- As suturas deverão ser retiradas após 7 a 10 dias na UBS mais próxima da sua residência."
    });

    // === 2. Popula Select (CRUCIAL: Fazer antes do Quill) ===
    const selectEl = document.getElementById("medicamentos");
    if (selectEl) {
        lista.forEach(function(item) {
            const op = document.createElement("option");
            op.text = item.nome || "(sem nome)";
            op.value = item.nome || "1";
            op.dataset.desc = item.descricao || "";
            op.dataset.pos = item.posologia || "";
            selectEl.add(op);
        });
    }

    // === 3. Preenche Dados da Página ===
    const dateInput = document.getElementById("data");
    if(dateInput) dateInput.value = (new Date).toLocaleDateString("sv-SE", { timeZone: "America/Sao_Paulo" });

    const params = new URLSearchParams(window.location.search);
    document.getElementById("nome_paciente").value = params.get("nome") || "";
    document.getElementById("id_paciente").value = params.get("id") || "";

    const u = { nome: params.get("unidade"), endereco: "Rua Marcilio Conrado, n 333 - Bairro Riacho Grande" };
    const pUnidade = params.get("unidade");
    
    if (pUnidade === "UPA RIACHO GRANDE") u.endereco = "Rua Marcilio Conrado, n 333 - Bairro Riacho Grande";
    else if (pUnidade === "UPA RUDGE RAMOS") u.endereco = "Rua Angela Tomé, n 256 - Bairro Rudge Ramos";
    else if (pUnidade === "UPA BAETA NEVES") u.endereco = "R. dos Vianas, 933 - Baeta Neves";
    else if (pUnidade === "UPA ALVES DIAS/ASSUNÇÃO") u.endereco = "Av. Humberto de Alcântara Castelo Branco, 4220 - Alves Dias";
    else if (pUnidade === "UPA UPA DEMARCHI/BATISTINI") u.endereco = "R. Valdomiro Luís, 303 - Demarchi";
    else if (pUnidade === "UPA PAULICEIA/TABOAO") u.endereco = "R. Pedro de Tolêdo, 326 - Paulicéia";
    else if (pUnidade === "UPA SAO PEDRO") u.endereco = "Av. Dom Pedro de Alcântara, 273 - Montanhão";
    else if (pUnidade === "UPA SILVINA") u.endereco = "Av. Dr. José Fornari, 509 - Ferrazópolis";
    else if (pUnidade === "UPA UNIÃO/ALVARENGA") u.endereco = "Estr. dos Alvarengas, 5779 - Alvarenga";
    else { u.nome = "UPA RIACHO GRANDE"; }

    document.getElementById("unidade_nome").innerHTML = u.nome || "";
    document.getElementById("unidade_endereco").innerHTML = u.endereco || "";

    // === 4. Inicia Quill ===
    const Font = Quill.import("formats/font");
    Font.whitelist = ["sans-serif", "serif", "monospace", "roboto", "msmadi"];
    Quill.register(Font, true);

    const Embed = Quill.import("blots/embed");
    class SoftBreak extends Embed {
        static blotName = "softbreak";
        static tagName = "br";
    }
    Quill.register(SoftBreak);

    quill = new Quill("#texto", {
        theme: "snow",
        modules: {
            toolbar: "#toolbar",
            keyboard: {
                bindings: {
                    softBreak: {
                        key: "Enter",
                        shiftKey: true,
                        handler: function(range) {
                            this.quill.insertEmbed(range.index, "softbreak", true, "user");
                            this.quill.setSelection(range.index + 1, 0, "silent");
                            return false;
                        }
                    }
                }
            }
        }
    });
});

window.onbeforeprint = function() {
    if (document.getElementById("segundavia") && document.getElementById("segundavia").checked) {
        const c = document.getElementById("page1").cloneNode(true);
        c.id = "page2";
        c.classList.add("printonly");
        document.body.classList.add("duasvias");
        document.body.appendChild(c);
    }
};

window.onafterprint = function() {
    const p2 = document.getElementById("page2");
    if (p2) p2.remove();
    document.body.classList.remove("duasvias");
};
</script>
<title>RECEITUÁRIO</title>
</head>
<body>
<div id="page1">
    <div id="pagenum" class="printonly"><span></span></div>
    <header>
        <img src="logo-sbc.jpg" height="100" align="left"/>
        <p>PREFEITURA DO MUNÍCIPIO DE SÃO BERNARDO DO CAMPO</p>
        <h2>RECEITUÁRIO</h2>
        <p>SECRETARIA DE SAÚDE</p>
    </header>
    <br/>
    <table class="paciente">
        <tr><th>NOME:</th><td><input type="text" id="nome_paciente"/></td></tr>
        <tr><th>HYGIA:</th><td><input type="text" id="id_paciente"/></td></tr>
    </table>
    <br/>
    <div id="toolbar" class="noprint">
        <span class="ql-formats">
            <select id="medicamentos" class="custom-select" onchange="addMedicamento(this)">
                <option hidden selected value="0">ADICIONAR MEDICAMENTO</option>
            </select>
        </span>
        <span class="ql-formats">
            <button type="button" class="custom-btn" onclick="limparTudo()">Limpar</button>
            <button type="button" class="custom-btn" onclick="window.print()">Imprimir</button>
        </span>
        <span class="ql-formats">
            <label class="custom-label"><input type="checkbox" id="segundavia"/> 2 vias</label>
        </span>
        <span class="ql-formats">
            <select class="ql-font">
                <option selected value="sans-serif">Sans</option>
                <option value="serif">Serif</option>
                <option value="monospace">Mono</option>
                <option value="roboto">Roboto</option>
                <option value="msmadi">Ms Madi</option>
            </select>
            <select class="ql-size">
                <option value="small"></option>
                <option selected></option>
                <option value="large"></option>
                <option value="huge"></option>
            </select>
        </span>
        <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
        </span>
        <span class="ql-formats">
            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats">
            <button class="ql-clean"></button>
        </span>
    </div>
    <div id="texto"></div>
    <table>
        <tr style="width:100%">
            <th>DATA:</th>
            <td style="width:300px"><input type="date" id="data"/></td>
            <td><input type="text" size="50"/></td>
        </tr>
        <tr><td colspan="2"></td><td align="center">CARIMBO E ASSINATURA</td></tr>
    </table>
    <h5 align="center">
        <span id="unidade_nome"></span> <br/>
        <span id="unidade_endereco"></span> <br/>
        São Bernardo do Campo - SP <br/>
        CNPJ: 46.523.239/0001-47
    </h5>
</div>
</body>
</html>
