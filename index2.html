<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAJ6TrAFy+8QCC0vgA7+/vAC6n7ACE0/gAS2RuAKbU5QDAwMAAv+3+ACek6gApoeYAAAAAAAAAAAAAAAAARERERERERABEREREREREAEREREREREQAREREeIRERABJmZSohUREAERERKolVEQAREREozUVRABJmZRDNlFUAEREREQzZRUAREREREM2W1BJmZmZRDNlxUREREREQzZVREREREREMzVJmZmZmURDM0REREREREQzRERERERERAMAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAA"
        rel="icon" type="image/x-icon" />

  <title>RECEITUÁRIO</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">

  <style>
    body{font-family:sans-serif;}
    header img{margin-right:10px;}
    th{padding-top:10px;}
    .paciente td{width:100%; border-bottom:1px solid #000;} /* Ajustei borda pra aparecer */
    td input[type=text]{width:100%; height:28px; text-transform:uppercase; border-width:0 0 1px 0; font:inherit; border-color: #000;}
    #data{height:28px; border-width:0 0 1px 0; text-align:center; font:inherit}

    /* Quill editor height (screen) */
    #texto{height: 640px;}

    #medicamentos,button{padding:5px;}
    #page1{page-break-after: always;}

    /* ====== QUILL CONTENT: bigger font ====== */
    .ql-editor{
      font-size: 16px;
      line-height: 1.5;
      counter-reset: med-counter; /* numbering reset */
    }

    /* linha 1 do item (título) */
    .med-title{
      counter-increment: med-counter;
      padding-left: 28px;
      position: relative;
      margin: 0;
    }

    /* número automático só no título */
    .med-title::before{
      content: counter(med-counter) ".";
      position: absolute;
      left: 0;
      top: 0;
      font-weight: bold;
    }

    /* linha 2 do item (posologia) */
    .med-pos{
      padding-left: 28px;           /* alinha com o texto do título */
      margin: 2px 0 12px 0;        /* espaçamento entre itens */
      padding-bottom: 6px;
      border-bottom: 1px dashed #bbb;
    }

    /* evita “borda sobrando” se for o último */
    .med-pos:last-child{
      margin-bottom: 0;
      border-bottom: 0;
    }

    /* Screen-only */
    @media screen {
      .printonly{display:none;}
      #pagenum{display:none;}
    }

    /* Print */
    @media print {
      @page { size: A4 portrait; margin: 10mm; }
      html, body { margin: 0; padding: 0; }

      /* hide controls */
      .noprint, .ql-toolbar { display:none !important; }

      #pagenum{
        display:block !important;
        position: relative;      
        font-size: 14px;
        text-align: right;
        margin: 0 0 4mm 0;
        padding: 0;
      }

      /* always break between vias */
      #page1 { break-after: page; page-break-after: always; }

      /* editor: limit in mm to avoid pushing footer to next page */
      #texto{
        border: 0 !important;
        height: 160mm;      /* ajuste fino: 155–165mm */
        overflow: hidden;
      }

      /* slightly larger on print */
      .ql-editor{
        font-size: 17px;
        line-height: 1.45;
      }

      /* avoid splitting footer */
      h5 { break-inside: avoid; page-break-inside: avoid; }

      /* via labels */
      body.duasvias #page1 #pagenum span::after { content:"1ª VIA FARMÁCIA"; }
      body.duasvias #page2 #pagenum span::after { content:"2ª VIA PACIENTE"; }
      body:not(.duasvias) #page1 #pagenum span::after { content:"VIA ÚNICA"; }
    }

    /* Font configs */
    .ql-font-sans-serif { font-family: sans-serif; }
    .ql-font-serif { font-family: serif; }
    .ql-font-monospace { font-family: monospace; }
    .ql-font-roboto { font-family: "Roboto", sans-serif; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="sans-serif"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="sans-serif"]::before { content: "Sans"; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="serif"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="serif"]::before { content: "Serif"; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="monospace"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="monospace"]::before { content: "Mono"; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="roboto"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="roboto"]::before { content: "Roboto"; }
  </style>

  <script src="medicamentos.json"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

  <script>
    let quill = null;

    // Função para inserir medicamento formatado
    function addMedicamento(selectEl) {
      const html = selectEl.value;
      if (!html || html === "0") return;
      if (!quill) return; // Segurança extra

      // inserir no fim (antes do \n final)
      const start = Math.max(0, quill.getLength() - 1);
      const beforeLen = quill.getLength();

      quill.clipboard.dangerouslyPasteHTML(start, html, 'user');

      const afterLen = quill.getLength();
      const insertedLen = afterLen - beforeLen;

      // pega as linhas inseridas
      const lines = quill.getLines(start, Math.max(1, insertedLen));

      // formata 1ª linha como título, 2ª como posologia
      if (lines[0]) {
        const idx0 = quill.getIndex(lines[0]);
        quill.formatLine(idx0, 1, 'medtitle', true, 'user');
      }
      if (lines[1]) {
        const idx1 = quill.getIndex(lines[1]);
        quill.formatLine(idx1, 1, 'medpos', true, 'user');
      }

      // garante uma linha em branco após o item
      quill.insertText(quill.getLength() - 1, "\n", 'user');

      selectEl.value = "0";
      selectEl.focus();
    }

    function limparTudo() {
      if (!quill) return;
      quill.setContents([]);
    }

    window.addEventListener('DOMContentLoaded', function () {
      
      // === Configuração de Fontes e Blots do Quill ===
      const Font = Quill.import('formats/font');
      Font.whitelist = ['sans-serif', 'serif', 'monospace', 'roboto'];
      Quill.register(Font, true);

      const Block = Quill.import('blots/block');
      class MedTitleBlot extends Block {
        static blotName = 'medtitle';
        static tagName = 'DIV';
        static className = 'med-title';
      }
      class MedPosBlot extends Block {
        static blotName = 'medpos';
        static tagName = 'DIV';
        static className = 'med-pos';
      }
      Quill.register(MedTitleBlot, true);
      Quill.register(MedPosBlot, true);

      // ============================================================
      // A CORREÇÃO PRINCIPAL ESTÁ AQUI: INICIALIZAR O QUILL
      // ============================================================
      quill = new Quill('#texto', {
        theme: 'snow',
        modules: {
          toolbar: '#toolbar' // Conecta a barra de ferramentas customizada
        }
      });

      // === Lógica de Dados e Layout ===
      
      // Load medicamentos from localStorage if present
      if (window.localStorage.medicamentos != undefined) {
        // Se existir no localStorage, usa ele
        var listaMedicamentos = JSON.parse(localStorage.medicamentos);
      } else if (typeof medicamentos !== 'undefined') {
        // Se existir no arquivo .json, usa ele
        var listaMedicamentos = medicamentos;
      } else {
        // Fallback vazio
        var listaMedicamentos = [];
      }

      // Date
      const data = document.getElementById('data');
      if(data) {
        // Ajuste para formato YYYY-MM-DD que o input type=date exige
        const hoje = new Date();
        const yyyy = hoje.getFullYear();
        const mm = String(hoje.getMonth() + 1).padStart(2, '0');
        const dd = String(hoje.getDate()).padStart(2, '0');
        data.value = `${yyyy}-${mm}-${dd}`;
      }

      // Populate medicamentos dropdown
      if (Array.isArray(listaMedicamentos)) {
        listaMedicamentos.forEach(function (element) {
          const option = document.createElement("option");
          option.text = element.nome;
          // Cria o HTML que será inserido no editor
          option.value = '<p><strong>' + element.descricao + '</strong></p><p>' + element.posologia + '</p>';
          document.getElementById('medicamentos').add(option);
        });
      }

      // URL params
      const urlParams = new URLSearchParams(window.location.search);
      if(document.getElementById('nome_paciente')) document.getElementById('nome_paciente').value = urlParams.get('nome') || '';
      if(document.getElementById('id_paciente')) document.getElementById('id_paciente').value = urlParams.get('id') || '';

      // Unidade
      const unidade = {
        nome: urlParams.get('unidade'),
        endereco: 'Rua Marcilio Conrado, n 333 - Bairro Riacho Grande'
      };

      switch (urlParams.get('unidade')) {
        case "UPA RIACHO GRANDE":
          unidade.endereco = 'Rua Marcilio Conrado, n 333 - Bairro Riacho Grande';
          break;
        case "UPA RUDGE RAMOS":
          unidade.endereco = 'Rua Angela Tomé, n 256 - Bairro Rudge Ramos';
          break;
        case "UPA BAETA NEVES":
          unidade.endereco = 'R. dos Vianas, 933 - Baeta Neves';
          break;
        case "UPA ALVES DIAS/ASSUNÇÃO":
          unidade.endereco = 'Av. Humberto de Alencar Castelo Branco, 4220 - Alves Dias';
          break;
        case "UPA UPA DEMARCHI/BATISTINI":
          unidade.endereco = 'R. Valdomiro Luís, 303 - Demarchi';
          break;
        case "UPA PAULICEIA/TABOAO":
          unidade.endereco = 'R. Pedro de Tolêdo, 326 - Paulicéia';
          break;
        case "UPA SAO PEDRO":
          unidade.endereco = 'Av. Dom Pedro de Alcântara, 273 - Montanhão';
          break;
        case "UPA SILVINA":
          unidade.endereco = 'Av. Dr. José Fornari, 509 - Ferrazópolis';
          break;
        case "UPA UNIÃO/ALVARENGA":
          unidade.endereco = 'Estr. dos Alvarengas, 5779 - Alvarenga';
          break;
        default:
          unidade.nome = 'UPA RIACHO GRANDE';
      }

      document.getElementById('unidade_nome').innerHTML = unidade.nome || '';
      document.getElementById('unidade_endereco').innerHTML = unidade.endereco || '';
    });

    // Lógica de Impressão (2 vias)
    window.onbeforeprint = function () {
      if (document.getElementById('segundavia').checked) {
        const clone = document.getElementById('page1').cloneNode(true);
        clone.id = 'page2';
        clone.classList.add('printonly');
        document.body.classList.add('duasvias');
        document.body.appendChild(clone);
      }
    }

    window.onafterprint = function () {
      const apagar = document.getElementById('page2');
      if (apagar) apagar.remove();
      document.body.classList.remove('duasvias');
    }
  </script>
</head>

<body>
  <div id="page1">
    <div id="pagenum" class="printonly"><span></span></div>

    <header>
      <img src="logo-sbc.jpg" height="100" align="left" alt="Logo" />
      <p>PREFEITURA DO MUNÍCIPIO DE SÃO BERNARDO DO CAMPO</p>
      <h2>RECEITUÁRIO</h2>
      <p>SECRETARIA DE SAÚDE</p>
    </header>

    <br/>

    <table class="paciente" style="width: 100%;">
      <tr>
        <th style="width: 60px; text-align: left;">NOME:</th>
        <td><input type="text" id="nome_paciente" /></td>
      </tr>
      <tr>
        <th style="width: 60px; text-align: left;">HYGIA:</th>
        <td><input type="text" id="id_paciente" /></td>
      </tr>
    </table>

    <br/>

    <p class="noprint">
      <select id="medicamentos" onchange="addMedicamento(this)">
        <option hidden selected value="0">ADICIONAR MEDICAMENTO</option>
      </select>

      <button type="button" onclick="limparTudo()">Limpar tudo</button>
      <button type="button" onclick="window.print()">Imprimir</button>
      <label><input type="checkbox" id="segundavia" /> Imprimir 2 vias</label>
    </p>

    <div id="toolbar" class="noprint">
      <span class="ql-formats">
        <select class="ql-font">
          <option selected value="sans-serif">Sans</option>
          <option value="serif">Serif</option>
          <option value="monospace">Mono</option>
          <option value="roboto">Roboto</option>
        </select>

        <select class="ql-size">
          <option value="small"></option>
          <option selected></option>
          <option value="large"></option>
          <option value="huge"></option>
        </select>
      </span>

      <span class="ql-formats">
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>
      </span>

      <span class="ql-formats">
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
      </span>

      <span class="ql-formats">
        <button class="ql-clean"></button>
      </span>
    </div>

    <div id="texto"></div>

    <table style="width:100%; margin-top: 20px;">
      <tr>
        <th style="width: 50px;">DATA:</th>
        <td style="width:200px"><input type="date" id="data" /></td>
        <td></td> <td style="width: 300px; border-top: 1px solid #000; text-align: center;">CARIMBO E ASSINATURA</td>
      </tr>
    </table>

    <h5 align="center" style="margin-top: 30px;">
      <span id="unidade_nome"></span> <br/>
      <span id="unidade_endereco"></span> <br/>
      São Bernardo do Campo - SP <br/>
      CNPJ: 46.523.239/0001-47
    </h5>
  </div>
</body>
</html>
