<!--Version 2.0.3-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAJ6TrAFy+8QCC0vgA7+/vAC6n7ACE0/gAS2RuAKbU5QDAwMAAv+3+ACek6gApoeYAAAAAAAAAAAAAAAAARERERERERABEREREREREAEREREREREQAREREeIRERABJmZSohUREAERERKolVEQAREREozUVRABJmZRDNlFUAEREREQzZRUAREREREM2W1BJmZmZRDNlxUREREREQzZVREREREREMzVJmZmZmURDM0REREREREQzRERERERERAMAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAA" rel="icon" type="image/x-icon"/>
<title>RECEITUÁRIO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Ms+Madi&family=Roboto:wght@400;700&display=swap');
body{font-family:sans-serif;margin:0;padding:8px}
header img{margin-right:10px}
th{padding-top:10px}
.paciente td{width:100%;border-bottom:1px solid #000}
td input[type=text]{width:100%;height:28px;text-transform:uppercase;border:none;border-bottom:1px solid #000;font:inherit;outline:none}
#data{height:28px;border:none;border-bottom:1px solid #000;text-align:center;font:inherit;outline:none}
#texto{height:640px}
#page1{page-break-after:always}
.ql-editor{font-size:16px;line-height:1.5}
.ql-editor br{display:inline}
.ql-editor ol{padding-left:28px;margin:0}
.ql-editor li{margin:0 0 12px 0;padding-bottom:6px;border-bottom:1px dashed #bbb}
.ql-editor li:last-child{margin-bottom:0;border-bottom:0}
.ql-editor li::marker{font-weight:bold}
/* Toolbar Customizada */
.ql-toolbar .custom-select{display:inline-block !important;height:24px;border:1px solid #ccc;border-radius:3px;font-size:12px;max-width:200px;vertical-align:top;margin-top:2px}
.ql-toolbar .custom-btn{border:1px solid #ccc!important;background:#fff!important;width:auto!important;height:24px!important;padding:0 8px!important;margin-right:5px!important;cursor:pointer;font-size:12px!important;border-radius:3px;vertical-align:top;margin-top:2px}
.ql-toolbar .custom-btn:hover{background:#f0f0f0!important}
.ql-toolbar .custom-label{font-size:12px;vertical-align:top;display:inline-block;margin-top:6px;margin-right:5px}
/* Fontes */
.ql-font-sans-serif{font-family:sans-serif}.ql-font-serif{font-family:serif}.ql-font-monospace{font-family:monospace}.ql-font-roboto{font-family:"Roboto",sans-serif}.ql-font-msmadi{font-family:"Ms Madi",cursive}
/* Impressão */
@media screen{.printonly,#pagenum{display:none}}
@media print{
 @page{size:A4 portrait;margin:10mm}
 body,html{margin:0;padding:0}
 .noprint,.ql-toolbar{display:none!important}
 #pagenum{display:block!important;position:relative;font-size:14px;text-align:right;margin:0 0 4mm 0}
 #page1{break-after:page;page-break-after:always}
 #texto{border:0!important;height:160mm;overflow:hidden}
 .ql-editor{font-size:17px;line-height:1.45}
 h5{break-inside:avoid;page-break-inside:avoid}
 body.duasvias #page1 #pagenum span::after{content:"1ª VIA FARMÁCIA"}
 body.duasvias #page2 #pagenum span::after{content:"2ª VIA PACIENTE"}
 body:not(.duasvias) #page1 #pagenum span::after{content:"VIA ÚNICA"}
}
</style>
<script src="medicamentos.json"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script>
let quill = null;

// Função Global
window.addMedicamento = function(el) {
    if (!quill) return;
    var opt = el.selectedOptions[0];
    if (!opt || opt.value === "0") return;
    
    var nome = opt.dataset.desc;
    var pos = opt.dataset.pos;
    if (!nome) return;

    var idx = Math.max(0, quill.getLength() - 1);
    
    // 1. Nome em negrito
    quill.insertText(idx, nome, { bold: true }, "user");
    var next = idx + nome.length;

    // 2. Posologia com quebras suaves (mesmo item da lista)
    if (pos) {
        quill.insertEmbed(next, "softbreak", true, "user");
        next++;
        var lines = pos.split("\n");
        for (var i = 0; i < lines.length; i++) {
            quill.insertText(next, lines[i], { bold: false }, "user");
            next += lines[i].length;
            if (i < lines.length - 1) {
                quill.insertEmbed(next, "softbreak", true, "user");
                next++;
            }
        }
    }

    // 3. Fecha item
    quill.insertText(next, "\n", {}, "user");
    quill.formatLine(idx, 1, "list", "ordered", "user");
    
    quill.setSelection(quill.getLength(), 0, "silent");
    el.value = "0";
    el.focus();
};

window.limparTudo = function() {
    if(quill) quill.setContents([]);
};

window.addEventListener("DOMContentLoaded", function() {
    // 1. Prepara Lista
    var lista = [];
    try {
        if(localStorage.medicamentos) lista = JSON.parse(localStorage.medicamentos);
        else if(window.medicamentos) lista = window.medicamentos;
    } catch(e){ if(window.medicamentos) lista = window.medicamentos; }
    
    lista.push({
        nome: "ORIENTAÇÕES DE SUTURA",
        descricao: "ORIENTAÇÕES DE CUIDADOS COM A SUTURA",
        posologia: "- Mantenha a área da sutura limpa e seca, limpando suavemente com água e sabão neutro;\n- Em caso de troca do curativo, use sempre gaze estéril e evite tocar a parte interna;\n- Retorne em caso de sinais como vermelhidão, inchaço, calor, dor intensa ou secreção purulenta;\n- Evite atividades físicas intensas, mantenha uma dieta equilibrada e hidrate-se bem;\n- As suturas deverão ser retiradas após 7 a 10 dias na UBS mais próxima da sua residência."
    });

    // 2. Preenche Select
    var sel = document.getElementById("medicamentos");
    if(sel){
        lista.forEach(function(item){
            var o = document.createElement("option");
            o.text = item.nome || "(sem nome)";
            o.value = item.nome || "1";
            o.dataset.desc = item.descricao || "";
            o.dataset.pos = item.posologia || "";
            sel.add(o);
        });
    }

    // 3. Configura Quill (Fontes e Blot)
    var Font = Quill.import("formats/font");
    Font.whitelist = ["sans-serif", "serif", "monospace", "roboto", "msmadi"];
    Quill.register(Font, true);

    var Embed = Quill.import("blots/embed");
    class SoftBreak extends Embed { static blotName = "softbreak"; static tagName = "br"; }
    Quill.register(SoftBreak);

    // 4. Inicia Editor
    quill = new Quill("#texto", {
        theme: "snow",
        modules: {
            toolbar: "#toolbar",
            keyboard: {
                bindings: {
                    softBreak: {
                        key: "Enter", shiftKey: true,
                        handler: function(range) {
                            this.quill.insertEmbed(range.index, "softbreak", true, "user");
                            this.quill.setSelection(range.index + 1, 0, "silent");
                            return false;
                        }
                    }
                }
            }
        }
    });

    // 5. Preenche dados
    document.getElementById("data").value = (new Date).toLocaleDateString("sv-SE", { timeZone: "America/Sao_Paulo" });
    var p = new URLSearchParams(window.location.search);
    document.getElementById("nome_paciente").value = p.get("nome") || "";
    document.getElementById("id_paciente").value = p.get("id") || "";
    
    var uNome = p.get("unidade") || "UPA RIACHO GRANDE";
    var uEnd = "Rua Marcilio Conrado, n 333 - Bairro Riacho Grande";
    
    if(uNome === "UPA RUDGE RAMOS") uEnd = "Rua Angela Tomé, n 256 - Bairro Rudge Ramos";
    else if(uNome === "UPA BAETA NEVES") uEnd = "R. dos Vianas, 933 - Baeta Neves";
    else if(uNome === "UPA ALVES DIAS/ASSUNÇÃO") uEnd = "Av. Humberto de Alcântara Castelo Branco, 4220 - Alves Dias";
    else if(uNome === "UPA UPA DEMARCHI/BATISTINI") uEnd = "R. Valdomiro Luís, 303 - Demarchi";
    else if(uNome === "UPA PAULICEIA/TABOAO") uEnd = "R. Pedro de Tolêdo, 326 - Paulicéia";
    else if(uNome === "UPA SAO PEDRO") uEnd = "Av. Dom Pedro de Alcântara, 273 - Montanhão";
    else if(uNome === "UPA SILVINA") uEnd = "Av. Dr. José Fornari, 509 - Ferrazópolis";
    else if(uNome === "UPA UNIÃO/ALVARENGA") uEnd = "Estr. dos Alvarengas, 5779 - Alvarenga";

    document.getElementById("unidade_nome").innerHTML = uNome;
    document.getElementById("unidade_endereco").innerHTML = uEnd;
});

window.onbeforeprint = function() {
    if(document.getElementById("segundavia").checked){
        var c = document.getElementById("page1").cloneNode(true);
        c.id = "page2"; c.classList.add("printonly");
        document.body.classList.add("duasvias");
        document.body.appendChild(c);
    }
};
window.onafterprint = function() {
    var p2 = document.getElementById("page2");
    if(p2) p2.remove();
    document.body.classList.remove("duasvias");
};
</script>
</head>
<body>
<div id="page1">
 <div id="pagenum" class="printonly"><span></span></div>
 <header>
  <img src="logo-sbc.jpg" height="100" align="left"/>
  <p>PREFEITURA DO MUNÍCIPIO DE SÃO BERNARDO DO CAMPO</p>
  <h2>RECEITUÁRIO</h2>
  <p>SECRETARIA DE SAÚDE</p>
 </header>
 <br/>
 <table class="paciente">
  <tr><th>NOME:</th><td><input type="text" id="nome_paciente"/></td></tr>
  <tr><th>HYGIA:</th><td><input type="text" id="id_paciente"/></td></tr>
 </table>
 <br/>
 <div id="toolbar" class="noprint">
  <span class="ql-formats">
   <select id="medicamentos" class="custom-select" onchange="addMedicamento(this)">
    <option hidden selected value="0">ADICIONAR MEDICAMENTO</option>
   </select>
  </span>
  <span class="ql-formats">
   <button type="button" class="custom-btn" onclick="limparTudo()">Limpar</button>
   <button type="button" class="custom-btn" onclick="window.print()">Imprimir</button>
  </span>
  <span class="ql-formats">
   <label class="custom-label"><input type="checkbox" id="segundavia"/> 2 vias</label>
  </span>
  <span class="ql-formats">
   <select class="ql-font">
    <option selected value="sans-serif">Sans</option>
    <option value="serif">Serif</option>
    <option value="monospace">Mono</option>
    <option value="roboto">Roboto</option>
    <option value="msmadi">Ms Madi</option>
   </select>
   <select class="ql-size">
    <option value="small"></option>
    <option selected></option>
    <option value="large"></option>
    <option value="huge"></option>
   </select>
  </span>
  <span class="ql-formats">
   <button class="ql-bold"></button>
   <button class="ql-italic"></button>
   <button class="ql-underline"></button>
  </span>
  <span class="ql-formats">
   <button class="ql-list" value="ordered"></button>
   <button class="ql-list" value="bullet"></button>
  </span>
  <span class="ql-formats">
   <button class="ql-clean"></button>
  </span>
 </div>
 <div id="texto"></div>
 <table>
  <tr style="width:100%">
   <th>DATA:</th>
   <td style="width:300px"><input type="date" id="data"/></td>
   <td><input type="text" size="50"/></td>
  </tr>
  <tr><td colspan="2"></td><td align="center">CARIMBO E ASSINATURA</td></tr>
 </table>
 <h5 align="center">
  <span id="unidade_nome"></span> <br/>
  <span id="unidade_endereco"></span> <br/>
  São Bernardo do Campo - SP <br/>
  CNPJ: 46.523.239/0001-47
 </h5>
</div>
</body>
</html>
