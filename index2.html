<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAJ6TrAFy+8QCC0vgA7+/vAC6n7ACE0/gAS2RuAKbU5QDAwMAAv+3+ACek6gApoeYAAAAAAAAAAAAAAAAARERERERERABEREREREREAEREREREREQAREREeIRERABJmZSohUREAERERKolVEQAREREozUVRABJmZRDNlFUAEREREQzZRUAREREREM2W1BJmZmZRDNlxUREREREQzZVREREREREMzVJmZmZmURDM0REREREREQzRERERERERAMAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAA"
        rel="icon" type="image/x-icon" />

  <style>
    body{font-family:sans-serif;}
    header img{margin-right:10px;}
    th{padding-top:10px;}
    .paciente td{width:100%; border-bottom:1px}
    td input[type=text]{width:100%; height:28px; text-transform:uppercase; border-width:0 0 1px 0; font:inherit}
    #data{height:28px; border-width:0 0 1px 0; text-align:center; font:inherit}

    /* Quill editor height (screen) */
    #texto{height: 640px;}

    #medicamentos,button{padding:5px;}
    #page1{page-break-after: always;}

    /* ====== QUILL CONTENT: bigger font ====== */
    .ql-editor{
      font-size: 16px;
      line-height: 1.5;
    }

    /* ====== Ordered list styling inside editor ====== */
    .ql-editor ol{
      padding-left: 28px; /* recuo */
      margin: 0;
    }
    .ql-editor li{
      margin: 0 0 12px 0;        /* espaçamento automático entre itens */
      padding-bottom: 6px;
      border-bottom: 1px dashed #bbb;
    }
    .ql-editor li:last-child{
      margin-bottom: 0;
      border-bottom: 0;
    }
    /* número em negrito */
    .ql-editor li::marker{
      font-weight: bold;
    }

    /* Screen-only */
    @media screen {
      .printonly{display:none;}
      #pagenum{display:none;}
    }

    /* Print */
    @media print {
      @page { size: A4 portrait; margin: 10mm; }
      html, body { margin: 0; padding: 0; }

      /* hide controls */
      .noprint, .ql-toolbar { display:none !important; }

      #pagenum{
        display:block !important;
        position: relative;
        font-size: 14px;
        text-align: right;
        margin: 0 0 4mm 0;
        padding: 0;
      }

      /* always break between vias */
      #page1 { break-after: page; page-break-after: always; }

      /* editor: limit in mm to avoid pushing footer to next page */
      #texto{
        border: 0 !important;
        height: 160mm;      /* ajuste fino: 155–165mm */
        overflow: hidden;
      }

      /* slightly larger on print */
      .ql-editor{
        font-size: 17px;
        line-height: 1.45;
      }

      /* avoid splitting footer */
      h5 { break-inside: avoid; page-break-inside: avoid; }

      /* via labels */
      body.duasvias #page1 #pagenum span::after { content:"1ª VIA FARMÁCIA"; }
      body.duasvias #page2 #pagenum span::after { content:"2ª VIA PACIENTE"; }
      body:not(.duasvias) #page1 #pagenum span::after { content:"VIA ÚNICA"; }
    }

    /* =========================
       FONTS for Quill (Font picker)
       ========================= */
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    .ql-font-sans-serif { font-family: sans-serif; }
    .ql-font-serif { font-family: serif; }
    .ql-font-monospace { font-family: monospace; }
    .ql-font-roboto { font-family: "Roboto", sans-serif; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="sans-serif"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="sans-serif"]::before { content: "Sans"; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="serif"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="serif"]::before { content: "Serif"; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="monospace"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="monospace"]::before { content: "Mono"; }

    .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="roboto"]::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="roboto"]::before { content: "Roboto"; }
  </style>

  <script src="medicamentos.json"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">

  <script>
    let quill = null;

    function addMedicamento(selectEl) {
      if (!quill) return;

      const opt = selectEl.selectedOptions && selectEl.selectedOptions[0];
      if (!opt || opt.value === "0") return;

      const desc = (opt.dataset && opt.dataset.desc) ? opt.dataset.desc : "";
      const pos  = (opt.dataset && opt.dataset.pos)  ? opt.dataset.pos  : "";
      if (!desc && !pos) return;

      // inserir no fim (antes do \n final)
      const idx = Math.max(0, quill.getLength() - 1);

      // Monta 1 linha (1 item de lista)
      // Descrição em negrito, depois separador e posologia
      const linha = `${desc} + `<br/>` + ${pos ? " — " + pos : ""}`;

      // Insere o texto
      quill.insertText(idx, linha, { bold: false }, 'user');

      // Deixa só a descrição em negrito
      if (desc.length > 0) {
        quill.formatText(idx, desc.length, { bold: true }, 'user');
      }

      // Fecha a linha e aplica LISTA ORDENADA nessa linha => vira <ol><li>...</li></ol>
      quill.insertText(idx + linha.length, "\n", { list: "ordered" }, 'user');

      // Mantém o cursor no fim, fora de uma seleção estranha
      quill.setSelection(quill.getLength() - 1, 0, 'silent');

      // Reset e foco no select
      selectEl.value = "0";
      selectEl.focus();
    }

    function limparTudo() {
      if (!quill) return;
      quill.setContents([]);
    }

    window.addEventListener('DOMContentLoaded', function () {
      // medicamentos: tenta localStorage, senão usa global do medicamentos.json, senão lista vazia
      let meds = [];
      try {
        if (window.localStorage.medicamentos != undefined) {
          meds = JSON.parse(localStorage.medicamentos);
        } else if (Array.isArray(window.medicamentos)) {
          meds = window.medicamentos;
        }
      } catch(e) {
        meds = Array.isArray(window.medicamentos) ? window.medicamentos : [];
      }

      // Whitelist fonts for Quill
      const Font = Quill.import('formats/font');
      Font.whitelist = ['sans-serif', 'serif', 'monospace', 'roboto'];
      Quill.register(Font, true);

      // Init Quill with custom toolbar
      quill = new Quill('#texto', {
        theme: 'snow',
        modules: { toolbar: '#toolbar' }
      });

      // Date
      const data = document.getElementById('data');
      data.value = new Date().toLocaleDateString("sv-SE", { timeZone: "America/Sao_Paulo" });

      // Populate medicamentos dropdown (usa dataset ao invés de HTML)
      const sel = document.getElementById('medicamentos');
      if (Array.isArray(meds)) {
        meds.forEach(function (element) {
          const option = document.createElement("option");
          option.text = element.nome;

          // value mantém "0" só pra placeholder; aqui pode ser o nome mesmo
          option.value = element.nome || "1";

          // guarda desc/pos em dataset pra inserir como texto formatável
          option.dataset.desc = element.descricao || "";
          option.dataset.pos  = element.posologia || "";

          sel.add(option);
        });
      }

      // URL params
      const urlParams = new URLSearchParams(window.location.search);
      document.getElementById('nome_paciente').value = urlParams.get('nome') || '';
      document.getElementById('id_paciente').value = urlParams.get('id') || '';

      // Unidade
      const unidade = {
        nome: urlParams.get('unidade'),
        endereco: 'Rua Marcilio Conrado, n 333 - Bairro Riacho Grande'
      };

      switch (urlParams.get('unidade')) {
        case "UPA RIACHO GRANDE":
          unidade.endereco = 'Rua Marcilio Conrado, n 333 - Bairro Riacho Grande';
          break;
        case "UPA RUDGE RAMOS":
          unidade.endereco = 'Rua Angela Tomé, n 256 - Bairro Rudge Ramos';
          break;
        case "UPA BAETA NEVES":
          unidade.endereco = 'R. dos Vianas, 933 - Baeta Neves';
          break;
        case "UPA ALVES DIAS/ASSUNÇÃO":
          unidade.endereco = 'Av. Humberto de Alencar Castelo Branco, 4220 - Alves Dias';
          break;
        case "UPA UPA DEMARCHI/BATISTINI":
          unidade.endereco = 'R. Valdomiro Luís, 303 - Demarchi';
          break;
        case "UPA PAULICEIA/TABOAO":
          unidade.endereco = 'R. Pedro de Tolêdo, 326 - Paulicéia';
          break;
        case "UPA SAO PEDRO":
          unidade.endereco = 'Av. Dom Pedro de Alcântara, 273 - Montanhão';
          break;
        case "UPA SILVINA":
          unidade.endereco = 'Av. Dr. José Fornari, 509 - Ferrazópolis';
          break;
        case "UPA UNIÃO/ALVARENGA":
          unidade.endereco = 'Estr. dos Alvarengas, 5779 - Alvarenga';
          break;
        default:
          unidade.nome = 'UPA RIACHO GRANDE';
          console.log('Unidade não fornecida');
      }

      document.getElementById('unidade_nome').innerHTML = unidade.nome || '';
      document.getElementById('unidade_endereco').innerHTML = unidade.endereco || '';
    });

    window.onbeforeprint = function () {
      if (document.getElementById('segundavia').checked) {
        const clone = document.getElementById('page1').cloneNode(true);
        clone.id = 'page2';
        clone.classList.add('printonly');
        document.body.classList.add('duasvias');
        document.body.appendChild(clone);
      }
    }

    window.onafterprint = function () {
      const apagar = document.getElementById('page2');
      if (apagar) apagar.remove();
      document.body.classList.remove('duasvias');
    }
  </script>

  <title>RECEITUÁRIO</title>
</head>

<body>
  <div id="page1">
    <div id="pagenum" class="printonly"><span></span></div>

    <header>
      <img src="logo-sbc.jpg" height="100" align="left" />
      <p>PREFEITURA DO MUNÍCIPIO DE SÃO BERNARDO DO CAMPO</p>
      <h2>RECEITUÁRIO</h2>
      <p>SECRETARIA DE SAÚDE</p>
    </header>

    <br/>

    <table class="paciente">
      <tr>
        <th>NOME:</th>
        <td><input type="text" id="nome_paciente" /></td>
      </tr>
      <tr>
        <th>HYGIA:</th>
        <td><input type="text" id="id_paciente" /></td>
      </tr>
    </table>

    <br/>

    <p class="noprint">
      <select id="medicamentos" onchange="addMedicamento(this)">
        <option hidden selected value="0">ADICIONAR MEDICAMENTO</option>
      </select>

      <button type="button" onclick="limparTudo()">Limpar tudo</button>
      <button type="button" onclick="window.print()">Imprimir</button>
      <label><input type="checkbox" id="segundavia" /> Imprimir 2 vias</label>
    </p>

    <!-- Custom toolbar for Quill (with font picker) -->
    <div id="toolbar" class="noprint">
      <span class="ql-formats">
        <select class="ql-font">
          <option selected value="sans-serif">Sans</option>
          <option value="serif">Serif</option>
          <option value="monospace">Mono</option>
          <option value="roboto">Roboto</option>
        </select>

        <select class="ql-size">
          <option value="small"></option>
          <option selected></option>
          <option value="large"></option>
          <option value="huge"></option>
        </select>
      </span>

      <span class="ql-formats">
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>
      </span>

      <span class="ql-formats">
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
      </span>

      <span class="ql-formats">
        <button class="ql-clean"></button>
      </span>
    </div>

    <!-- Editor -->
    <div id="texto"></div>

    <table>
      <tr style="width:100%">
        <th>DATA:</th>
        <td style="width:300px"><input type="date" id="data" /></td>
        <td><input type="text" size="50" /></td>
      </tr>
      <tr>
        <td colspan="2"></td>
        <td align="center">CARIMBO E ASSINATURA</td>
      </tr>
    </table>

    <h5 align="center">
      <span id="unidade_nome"></span> <br/>
      <span id="unidade_endereco"></span> <br/>
      São Bernardo do Campo - SP <br/>
      CNPJ: 46.523.239/0001-47
    </h5>
  </div>
</body>
</html>
